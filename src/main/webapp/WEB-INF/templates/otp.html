<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Enter OTP</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    .otp-input {
      width: 3.5rem;
      height: 3.5rem;
      text-align: center;
      font-size: 1.4rem;
      border-radius: 0.5rem;
    }
    .otp-group { gap: .5rem; }
    .small-muted { font-size: .9rem; color: #6c757d; }
  </style>
</head>
<body class="bg-light">
  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-11 col-sm-8 col-md-6 col-lg-5">
        <div class="card shadow-sm">
          <div class="card-body p-4">
            <h4 class="mb-1">Verify OTP</h4>
            <p class="small-muted mb-3">We sent a 6-digit code to <strong th:text="${maskedContact}">+91-xxxxxx1234</strong>. Enter it below to continue.</p>

            <!-- flash messages -->
            <div th:if="${error != null}" class="alert alert-danger" th:text="${error}"></div>
            <div th:if="${info != null}" class="alert alert-info" th:text="${info}"></div>

            <!-- OTP form -->
            <form th:action="@{/otpverify}" method="post" id="otpForm" class="mb-3">
              <!-- CSRF (Spring Security) -->
              <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

              <!-- a hidden single field collects full OTP for server -->
              <input type="hidden" name="otp" id="otpHidden"/>

              <div class="d-flex justify-content-center align-items-center otp-group mb-3" role="group" aria-label="One time password">
                <input class="form-control otp-input" inputmode="numeric" pattern="[0-9]*" maxlength="1" aria-label="Digit 1" id="otp1" />
                <input class="form-control otp-input" inputmode="numeric" pattern="[0-9]*" maxlength="1" aria-label="Digit 2" id="otp2" />
                <input class="form-control otp-input" inputmode="numeric" pattern="[0-9]*" maxlength="1" aria-label="Digit 3" id="otp3" />
                <input class="form-control otp-input" inputmode="numeric" pattern="[0-9]*" maxlength="1" aria-label="Digit 4" id="otp4" />
                <input class="form-control otp-input" inputmode="numeric" pattern="[0-9]*" maxlength="1" aria-label="Digit 5" id="otp5" />
                <input class="form-control otp-input" inputmode="numeric" pattern="[0-9]*" maxlength="1" aria-label="Digit 6" id="otp6" />
              </div>

              <div class="d-flex justify-content-between align-items-center mb-3">
                <button type="submit" class="btn btn-primary" id="verifyBtn">Verify</button>
                <a th:href="@{/otp/resend}" class="btn btn-link small">Resend code</a>
              </div>

              <div class="text-center small text-muted">Didn't receive? Check spam or request again.</div>
            </form>

            <div class="text-center mt-3">
              <a th:href="@{/login}" class="link-secondary small">Back to login</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- JS (handles auto-advance/backspace/paste and submits hidden otp) -->
  <script>
    (function(){
      const inputs = Array.from(document.querySelectorAll('.otp-input'));
      const hidden = document.getElementById('otpHidden');
      const form = document.getElementById('otpForm');

      // focus first input on load
      if (inputs.length) inputs[0].focus();

      // allow only digits, move focus
      inputs.forEach((input, idx) => {
        input.addEventListener('input', (e) => {
          const val = input.value.replace(/\D/g,'');
          input.value = val;
          if (val && idx < inputs.length - 1) inputs[idx + 1].focus();
          collectToHidden();
        });

        input.addEventListener('keydown', (e) => {
          if (e.key === 'Backspace' && input.value === '' && idx > 0) {
            inputs[idx - 1].focus();
          } else if (e.key === 'ArrowLeft' && idx > 0) {
            inputs[idx - 1].focus();
            e.preventDefault();
          } else if (e.key === 'ArrowRight' && idx < inputs.length - 1) {
            inputs[idx + 1].focus();
            e.preventDefault();
          }
        });

        // support paste of full OTP into any input
        input.addEventListener('paste', (e) => {
          e.preventDefault();
          const paste = (e.clipboardData || window.clipboardData).getData('text').replace(/\D/g,'');
          if (!paste) return;
          for (let i = 0; i < inputs.length; i++) {
            inputs[i].value = paste[i] || '';
          }
          // focus last filled or last input
          const lastFilled = Math.min(paste.length, inputs.length) - 1;
          inputs[Math.max(0, lastFilled)].focus();
          collectToHidden();
        });
      });

      function collectToHidden(){
        hidden.value = inputs.map(i => i.value || '').join('');
      }

      // before submit, validate length
      form.addEventListener('submit', function(e){
        collectToHidden();
        if (hidden.value.length !== inputs.length) {
          e.preventDefault();
          // show a tiny client-side message (could also use a better UI)
          alert('Please enter the full ' + inputs.length + '-digit code.');
        }
      });
    })();
  </script>
</body>
</html>
